<!doctype html>
<html lang="en">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<style>

  .margin-bottom {
      margin-bottom: 15px ;
  }

  .nav{
    max-height: 30px;
    overflow-y: scroll;
  }

  .blinking{
	animation:blinkingText 0.5s infinite;
  }
  
  @keyframes blinkingText{
	0%  {   color: #000;	    }
	49% {	color: transparent;	}
	50% {	color: transparent;	}
	99% {	color: transparent;	}
	100%{	color: #000;	    }
  }

</style>

<script src="fabric.js"></script>
<script src="util.js"></script>
<script src="node.js"></script>
<script src="tree.js"></script>
<script src="board.js"></script>
<script src="guiBoard.js"></script>
<script src="myTbox.js"></script>

    
<div class="jumbotron text-center ">
	<h1>Monte Carlo Tree Search Algorithm </h>
		<h3> Ravi Saripalli </h3> <h4> 26th November 2018 </h4>
		<p>	A test bed with the simple Tic Toc Toe game </p>
</div>

<div class="container">
  <div class="row">

	   <div class="col-md-3">
	   <div class="row">
		  <h3>Parameters</h3>
			 <label class="col-md-8">No. of Expolorations:</label>
			 <input class="col-md-4 margin-bottom" type="number" min=0 step=10  id="nexp">

			 <label class="col-md-8"> No. of Simulations:</label>
			 <input class="col-md-4 margin-bottom" type="number" min=0 step=10 id="nsim">

			 <label class="col-md-8">Exploration Factor:</label>
			 <input class="col-md-4 margin-bottom" type="number" min=0 max=2 step=0.1 id="utcf">

			 <button id="simbtn" type="button" 
				 class="btn btn-primary col-md-4 margin-bottom"  >simulate</button>
         </div>

           <div class="row">
		   
		     <label class="col-md-8">Total Nodes in the Tree:</label>
		     <label class="col-md-4" id="lblnodes"> ...</label>	    
	
		      <button id="btnplay" type="button" 
				 class="btn btn-primary col-md-12 " >play</button>
				 <span class="col-md-8"></span>
				 	     
		    
		     <label class="col-md-8">Percent Wins :</label>
		     <label class="col-md-4" id="lblPWins">...</label>

		     <label class="col-md-8">Mean</label>
		     <label class="col-md-4" id="lblMean">...</label>
		     <label class="col-md-8">Std</label>
		     <label class="col-md-4" id="lblStd">...</label>
		   </div>
		</div>

	   <div class="col col-md-9 margin-bottom" >
		  <h3>Tic Toc Toe</h3>
		  <canvas id="canvas">  </canvas>	
		   <div class="col-md-12 margin-bottom" id="outcome" >
		   </div> 
	  </div>

  </div> 

  <div class=row>
      <h3>Status</h3>
    <div id="status" class=well rounded style="height:60px; overflow: scroll">
    </div>
  </div>

</div>
<script>
   
 var canvas = new fabric.Canvas("canvas", {backgroundColor: 'lightyellow',
                                              width: 400, height: 400});
 var gb = new guiBoard (canvas) ;

  // var my = new myTbox ("Ravi Sankar", 150, 100);
  //my.group.top = 100 ;  my.group.left = 100 ;  my.flashtxt(true);


var game = {} ;

    $(document).ready(function() {

      $("#nsim").val(100) ;
      $("#nexp").val(100) ;
      $("#utcf").val(0.2) ;
    }); // end of Initial Set up





function miniPlay () {  // Breaking down big iteration execution
                            // with setTimeOut
	    const NPLAYS = 100 ;
        const NBATCHS = 100 ;
        const DELAY = 1 ; // milliseconds

			   ab = game.learntPlay() ;  gb.setState(ab); canvas.renderAll() ;// show it
			   win = ab.player && (ab.result == "WIN")	;
			    let txt = win ? "o: Wins!!" : "o:((" ;	
			    $("#outcome").html("batch: " + data.nbatch +  " play:" + data.count + "  " + txt);
		  
			   if (win) {
			   	  data.count = data.count + 1 ;				   	 

			   }
			   
			   if ( data.nplays < NPLAYS ) {
			   	  data.nplays ++ ;
			   	  setTimeout (miniPlay, DELAY) ;
			   } else if (data.nbatch < NBATCHS ){
			   	  data.wins.push (data.count);
			   	  data.count = 0 ;
			   	  data.nplays = 0 ;
			   	  data.nbatch ++ ;
			   	  setTimeout (miniPlay, DELAY)
			   	  let stats = getStats(data.wins);
			   	    $("#lblPWins").html(data.wins[data.nbatch-1]);
			   	    $("#lblMean").html(stats.mean.toPrecision(2));
			   	      $("#lblStd").html(stats.std.toPrecision(2));
			   }

// We have our answers
   // console.log (this.data.wins) ;
   // console.log (getStats (this.data.wins));
			          
} // end MiniPlay


$("#btnplay").click (function() {
	data = {wins:[], count: 0, nplays:0, nbatch: 0}	;
	miniPlay () ;
});


$("#simbtn").click(function() {
  
  status ("Started Tree Search") ;
    game = new tree(); game.UTCF =  $("#utcf").val() ;
   console.log("Root Node: \n", game.root);
  
  for (let i=0 ; i < $("#nexp").val() ; i++) {  
     game.select() ;  
     for(let j=0 ; j < $("#nsim").val() ; j++) {   
        game.simulate() ;   
        game.propagate() ;   
  }};

  status ("Tree Search Completed") ;
  $("#lblnodes").html(game.NodeSet.length) ;

}); // Simulation button click 



// Script that provides the user interface
function status(msg) { // Add messages to status
    // an easier way is to use innerHTML but that is not safe!!!
    var br = document.createElement("br") ;
    var d = new Date();    var n = d.toLocaleString();
    var content = document.createTextNode(n + ": " + msg) ; 
    $("#status").append(br, content) ;
}

function getStats (vec) {

  var mean = 0 ;
  for (let i=0 ; i<vec.length ; i++)  {mean = mean + vec[i]};
  mean = mean / vec.length ;

  var std = 0 ;
  for (let i=0 ; i<vec.length ; i++)  {std = std + Math.pow((vec[i] - mean),2)};
  std = Math.sqrt (std / (vec.length -1)); 

  return ({mean: mean, std: std}) ;
} // end getStats
</script>

</html>

