<!doctype html>
<html lang="en">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="flot/jquery.flot.js"></script>
<style>

  .margin-bottom {
      margin-bottom: 15px ;
  }

  .nav{
    max-height: 30px;
    overflow-y: scroll;
  }

  .blinking{
	animation:blinkingText 0.5s infinite;
  }
  
  @keyframes blinkingText{
	0%  {   color: #000;	    }
	49% {	color: transparent;	}
	50% {	color: transparent;	}
	99% {	color: transparent;	}
	100%{	color: #000;	    }
  }

</style>

<script src="fabric.js"></script>
<script src="util.js"></script>
<script src="node.js"></script>
<script src="tree.js"></script>
<script src="board.js"></script>
<script src="guiBoard.js"></script>
<script src="myTbox.js"></script>

    
<div class="jumbotron text-center ">
	<h1>Monte Carlo Tree Search Algorithm </h>
		<h3> Ravi Saripalli </h3> <h4> 26th November 2018 </h4>
		<p>	A test bed with the simple Tic Tac Toe game </p>
</div>

<div class="container">
    <div class="row"> <!--container row1  -->

	   <div class="col-md-3">
		   <div class="row">
			  <h3>Parameters</h3>
				 <label class="col-md-8">No. of Expolorations:</label>
				 <input class="col-md-4 margin-bottom" type="number" min=0 step=10  id="nexp">
		   </div>
		   <div class="row">
				 <label class="col-md-8"> No. of Simulations:</label>
				 <input class="col-md-4 margin-bottom" type="number" min=0 step=10 id="nsim">
		   </div>

		   <div class="row">
				 <label class="col-md-8">Exploration Factor:</label>
				 <input class="col-md-4 margin-bottom" type="number"  
					  data-toggle="tooltip" title="Upper Confidence Bound Tree (UCT) factor. Increase it to encourage selection of neglected children"
                                          min=0 max=2 step=0.1 id="utcf">
		   </div>

		   <div class="row">
				 <button id="simbtn" type="button" 
					 data-toggle="tooltip" title="Runs through selection, expansion, simulation, propagation cycles"
					 class="btn btn-primary col-md-4 margin-bottom"  >simulate</button>
	  	   </div>

		  <div class="row">		   
				 <label class="col-md-8" data-toggle="tooltip" title="Nodes discovered">Total Nodes:</label>
				 <label class="col-md-4" id="lblnodes"> ...</label>	    
          </div>

		  <div class="row">		   
                 <button  id="btnplay" type="button" 
			     data-toggle="tooltip" title="Runs 100 batches of real 100 plays based on the above learning."
                 class="btn btn-primary col-md-4">play</button> 
          </div>

		  <div class="row">		   
				 <label class="col-md-8"
				  data-toggle="tooltip" title="Number of wins in the current batch of plays">Percent Wins :</label>
				 <label class="col-md-4" id="lblPWins">...</label>
                  </div>

		  <div class="row">		   
				 <label class="col-md-8"
					 data-toggle="tooltip" title="Statistics based on all batches of plays">Mean</label>
				 <label class="col-md-4" id="lblMean">...</label>
          </div>

		  <div class="row">		   
				 <label class="col-md-8">Std</label>
				 <label class="col-md-4" id="lblStd">...</label>
		 </div>
       </div> <!-- end large first column -->

       <div class="col-md-9 margin-bottom" >
		  <div class="row">		   
			<h3>Tic Tac Toe</h3>
			<div  class="col-md-6">
			      <canvas id="canvas"></canvas></div>
			<div  class="col-md-6">
     		       <img src= "mcts.png" width=100%></img></div>	 
	          </div> 
		  <div class="row">		   
   	              <div class="col-md-12 margin-bottom" id="outcome" >
	      </div> 
            </div>  <!-- end large second column -->

      </div> <!-- end container row1 -->

      <div class=row>  <!-- container row 2 -->
        <h3>Status</h3>
        <div id="status" class=well rounded style="height:60px; overflow: scroll"> </div>
      </div>  <!--  end container row2 -->

      
     <div id="plotarea" class=well style="height:400px"></div>


  </div> <!-- end container -->
<script>
   
 var canvas = new fabric.Canvas("canvas", {backgroundColor: 'lightyellow',
                                              width: 400, height: 400});
 var gb = new guiBoard (canvas) ;

 var myplot = { 
                     id: "#plotarea",
                 series: [],
                 options: {  // flot plot default options
   	                       series: {
	                                 lines: { show: true },
	                                 points: { show: true }
	                               }}};
                          

var game = {} ;


var ticker = true ;
var tickerID = setInterval(function(){ticker = !ticker},10);

var sim = {nexp: 100, nsim: 100, utcf: 0.2};


$(document).ready(function() {
      $("#nsim").val(sim.nsim) ;
      $("#nexp").val(sim.nexp) ;
      $("#utcf").val(sim.utcf) ;
    }); // end of Initial Set up


function miniPlay (data) { // updates data statistics after several plays back in data
 // Breaking down big iteration execution
                        // with setTimeOut
	    const NPLAYS = 100 ;  // in a batch
        const NBATCHS = 100 ; // no. of batches
        const DELAY = 1 ;    // milliseconds .. yielding
        
        // Kludge to allow Timeout function to be used with miniPlay which takes an argument
        var myfun = function (param) {
        	             setTimeout (function (){ miniPlay (param); }, DELAY) ; }

			    ab = game.learntPlay() ;  			  
			    win = ab.player && (ab.result == "WIN")	;
			    
				if (ticker) { // We display every so often (crude setup)
					  gb.setState(ab); canvas.renderAll() ;// show it			    
					  let txt = win ? "o: Wins!!" : "o:((" ;	
					  $("#outcome").html("batch: " + data.nbatch +  " play:" + data.count + "  " + txt);
				}

			   if (win) {
			   	  data.count = data.count + 1 ;				   	 
			   }
			   
			   if ( data.nplays < NPLAYS ) {
			   	       data.nplays ++ ;
			   	       myfun (data, DELAY) ;
			   	       //setTimeout (miniPlay, DELAY) ;

			   } else if (data.nbatch < NBATCHS ){
			   	    data.wins.push (data.count);
			   	    data.count = 0 ;
			   	    data.nplays = 0 ;
			   	    data.nbatch ++ ;
			   	    myfun (data) ;
			   	    // setTimeout (miniPlay, DELAY) ;
			   	    $("#lblPWins").html(data.wins[data.nbatch-1]);		   	       
                  			   	  			   	   
			   } else { // All batches done
	                let stats = getStats(data.wins);
	                data.stats = stats ;
                    $("#lblMean").html(stats.mean.toPrecision(2));
	                $("#lblStd").html(stats.std.toPrecision(2));	
                    status("miniPlay Done Calling back"); 
                    data.cb(data) ; // make the call back passing info                  
			   }

} // end MiniPlay


function doit(count) {// some batch process that gives some trends
   const NMAX = 100 ;

    if (count == 0) {
        sim = {nexp: 100, nsim: 100, utcf: 0.2};
        myplot.series.push({label: "100,100,0.2 CyclePlay", data: []}) ;
    }

    var myfun = function (param) {
        	             setTimeout (function (){ doit (param); }, 10) ; }   
 
    if ( count < NMAX )
    {
		mtsCycle();

		let cb = function (data) {
						myplot.series[0].data.push([count+1, data.stats.mean]);
						$.plot(myplot.id, myplot.series, myplot.options);  
						count = count + 1;
						doit (count);
						//console.log(myplot.series[0].data);
				 } // end callback definition

		let data = {wins: [], nplays: 0, nbatch: 0,
					   count: 0, stats: {},  cb: cb};
		miniPlay (data) ;
    } else {
    	console.log ("We are Done");
    }
	  
} // end doit

$(function(){doit(0);})

$("#btnplay").click (function() {
    var data = {wins: [], nplays: 0, nbatch: 0, count: 0, stats: {} };
	miniPlay (data) ;
	console.log(data);
});


$("#simbtn").click(function() {
  
	  status ("Started Tree Search") ;
	  sim.nexp = $("#nexp").val();
	  sim.nsim = $("#nsim").val();
	  sim.utcf = $("#utcf").val();
	  mtsCycle();
	  status ("Tree Search Completed") ;
	  $("#lblnodes").html(game.NodeSet.length) ;

}); // Simulation button click 


function mtsCycle() { // MonteCarlo Tree SEP

  game = new tree(); game.UTCF =  sim.utcf;
  
  for (let i=0 ; i < sim.nexp ; i++) {  
     game.select() ;  
     for(let j=0 ; j < sim.nsim ; j++) {   
        game.simulate() ;   
        game.propagate() ;   
     }};
} // end mtsCycle




// Script that provides the user interface
function status(msg) { // Add messages to status
    // an easier way is to use innerHTML but that is not safe!!!
    var br = document.createElement("br") ;
    var d = new Date();    var n = d.toLocaleString();
    var content = document.createTextNode(n + ": " + msg ) ; 
    var stat =  $("#status") ;
    stat.append(br, content) ;
    stat.scrollTop(40)  ; 
}
			     
</script>

</html>

